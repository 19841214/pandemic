import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Play, Pause, RotateCcw, Activity, TrendingUp, Skull, ShieldAlert, Zap, FileText, TrendingDown, Building2 } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } from 'recharts';

/**
 * æ¨¡æ“¬åƒæ•¸è¨­å®š (ç¶“æ¿Ÿé€£å‹•ç‰ˆ)
 */
const POPULATION_SIZE = 400;
const INITIAL_INFECTED = 5;
const INFECTION_RADIUS = 12;
const INFECTION_PROBABILITY = 0.25; 
const RECOVERY_TIME = 600; 
const IMMUNITY_DURATION = 2400; 
const HOSPITAL_CAPACITY = 50; 
const BASE_DEATH_RATE = 0.01; 
const OVERWHELMED_DEATH_RATE = 0.50; 

// ç¶“æ¿Ÿåƒæ•¸
const LABOR_VALUE_PER_PERSON = 0.2; // æ¯å€‹äººçš„ç¶“æ¿Ÿè²¢ç»å€¼
const PANIC_PENALTY = 15; // é†«ç™‚å´©æ½°æ™‚çš„ææ…Œæ‰£åˆ†

// ç‹€æ…‹é¡è‰²
const COLORS = {
  HEALTHY: '#3b82f6', // è—è‰²
  INFECTED: '#ef4444', // ç´…è‰²
  RECOVERED: '#10b981', // ç¶ è‰²
  DEAD: '#1f2937',     // é»‘è‰²
};

const App = () => {
  // æ¨¡æ“¬ç‹€æ…‹
  const [agents, setAgents] = useState([]);
  const [isPlaying, setIsPlaying] = useState(false);
  const [policyStringency, setPolicyStringency] = useState(0); 
  const [stats, setStats] = useState({ 
    healthy: 0, 
    infected: 0, 
    recovered: 0, 
    dead: 0, 
    peakInfected: 0,
    daysOverwhelmed: 0, // é†«ç™‚å´©æ½°æ™‚é•·
    cumulativeEcoLoss: 0 // ç´¯è¨ˆç¶“æ¿Ÿæå¤±
  });
  const [history, setHistory] = useState([]);
  const [economy, setEconomy] = useState(100);
  const [time, setTime] = useState(0);
  
  const requestRef = useRef();
  const canvasRef = useRef(null);
  const containerRef = useRef(null);

  // åˆå§‹åŒ–
  const initializeSimulation = useCallback(() => {
    const newAgents = [];
    const width = containerRef.current ? containerRef.current.clientWidth : 600;
    const height = 400;

    for (let i = 0; i < POPULATION_SIZE; i++) {
      newAgents.push({
        id: i,
        x: Math.random() * width,
        y: Math.random() * height,
        vx: (Math.random() - 0.5) * 2,
        vy: (Math.random() - 0.5) * 2,
        status: i < INITIAL_INFECTED ? 'INFECTED' : 'HEALTHY',
        timer: 0,
        immunityTimer: 0, 
      });
    }
    setAgents(newAgents);
    setStats({ 
      healthy: POPULATION_SIZE - INITIAL_INFECTED, 
      infected: INITIAL_INFECTED, 
      recovered: 0, 
      dead: 0, 
      peakInfected: INITIAL_INFECTED,
      daysOverwhelmed: 0,
      cumulativeEcoLoss: 0
    });
    setHistory([{ time: 0, infected: INITIAL_INFECTED, dead: 0, economy: 100 }]);
    setEconomy(100);
    setTime(0);
  }, []);

  useEffect(() => {
    initializeSimulation();
  }, [initializeSimulation]);

  // æ›´æ–°é‚è¼¯
  const update = useCallback(() => {
    if (!containerRef.current) return;
    const width = containerRef.current.clientWidth;
    const height = 400;

    setAgents(prevAgents => {
      let currentInfectedCount = 0;
      let currentDeadCount = 0;
      let currentRecoveredCount = 0;
      let currentHealthyCount = 0;
      
      const totalInfected = prevAgents.filter(a => a.status === 'INFECTED').length;
      const isOverwhelmed = totalInfected > HOSPITAL_CAPACITY;

      // --- ç¶“æ¿Ÿæ¨¡å‹æ›´æ–° (æ›´åˆç†çš„è¡æ“Šè¨ˆç®—) ---
      setEconomy(prevEco => {
        // 1. å‹å‹•åŠ›ä¸Šé™ï¼šæ¯æ­»ä¸€å€‹äººï¼Œç¶“æ¿Ÿå¤©èŠ±æ¿å°±æ°¸ä¹…ä¸‹é™
        const maxPotentialEco = 100 - (currentDeadCount * LABOR_VALUE_PER_PERSON * 2.5);
        
        // 2. æ”¿ç­–ä»£åƒ¹ï¼šå°æ§å°è‡´çš„ç›´æ¥ä¸‹æ»‘
        const policyCost = policyStringency * 0.7;
        
        // 3. ç–«æƒ…ææ…Œä»£åƒ¹ï¼šç”Ÿç—…ç„¡æ³•å·¥ä½œ + é†«ç™‚å´©æ½°å°è‡´çš„æ¶ˆè²»ç¸®æ‰‹
        let healthCrisisCost = (currentInfectedCount * 0.1); 
        if (isOverwhelmed) healthCrisisCost += PANIC_PENALTY; // å´©æ½°æ™‚ææ…Œå¤§å¢

        const targetEco = Math.max(0, maxPotentialEco - policyCost - healthCrisisCost);
        
        // ç¶“æ¿ŸæŒ‡æ•¸è¶¨å‘ç›®æ¨™å€¼ (æ…£æ€§)
        return prevEco + (targetEco - prevEco) * 0.05; 
      });

      // 1. ç§»å‹•èˆ‡ç‹€æ…‹æ›´æ–°
      const newAgents = prevAgents.map(agent => {
        if (agent.status === 'DEAD') {
          currentDeadCount++;
          return agent;
        }

        const speedFactor = Math.max(0.05, 1 - (policyStringency / 100)); 
        let nextX = agent.x + agent.vx * speedFactor * 1.0; 
        let nextY = agent.y + agent.vy * speedFactor * 1.0;

        if (nextX <= 0 || nextX >= width) agent.vx *= -1;
        if (nextY <= 0 || nextY >= height) agent.vy *= -1;
        nextX = Math.max(0, Math.min(width, nextX));
        nextY = Math.max(0, Math.min(height, nextY));

        let newStatus = agent.status;
        let newTimer = agent.timer;
        let newImmunityTimer = agent.immunityTimer;

        if (agent.status === 'INFECTED') {
          currentInfectedCount++;
          newTimer++;
          
          if (newTimer > RECOVERY_TIME) {
            const deathChance = isOverwhelmed ? OVERWHELMED_DEATH_RATE : BASE_DEATH_RATE;
            if (Math.random() < deathChance) {
              newStatus = 'DEAD';
            } else {
              newStatus = 'RECOVERED';
              newImmunityTimer = 0; 
            }
          }
        } else if (agent.status === 'RECOVERED') {
          currentRecoveredCount++;
          newImmunityTimer++;
          if (newImmunityTimer > IMMUNITY_DURATION) {
            newStatus = 'HEALTHY';
            newTimer = 0;
          }
        } else {
          currentHealthyCount++;
        }

        return { ...agent, x: nextX, y: nextY, status: newStatus, timer: newTimer, immunityTimer: newImmunityTimer, vx: agent.vx, vy: agent.vy };
      });

      // 2. å‚³æŸ“é‚è¼¯
      const effectiveInfectionProb = INFECTION_PROBABILITY * (1 - (policyStringency / 120));

      for (let i = 0; i < newAgents.length; i++) {
        if (newAgents[i].status !== 'INFECTED') continue;
        for (let j = 0; j < newAgents.length; j++) {
          if (i === j || newAgents[j].status !== 'HEALTHY') continue;
          const dx = newAgents[i].x - newAgents[j].x;
          const dy = newAgents[i].y - newAgents[j].y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          if (distance < INFECTION_RADIUS) {
            if (Math.random() < effectiveInfectionProb) newAgents[j].status = 'INFECTED';
          }
        }
      }

      setStats(prev => ({
        healthy: currentHealthyCount,
        infected: currentInfectedCount,
        recovered: currentRecoveredCount,
        dead: currentDeadCount,
        peakInfected: Math.max(prev.peakInfected, currentInfectedCount),
        daysOverwhelmed: isOverwhelmed ? prev.daysOverwhelmed + 1 : prev.daysOverwhelmed,
        cumulativeEcoLoss: prev.cumulativeEcoLoss + (100 - economy) // ç´¯è¨ˆæå¤±ç©åˆ†
      }));

      return newAgents;
    });

    setTime(prev => {
      const nextTime = prev + 1;
      if (nextTime % 15 === 0) { 
        setHistory(prevHist => {
           const newHist = [...prevHist, { time: nextTime, infected: stats.infected, dead: stats.dead, economy: economy }];
           if (newHist.length > 80) newHist.shift();
           return newHist;
        });
      }
      return nextTime;
    });

  }, [policyStringency, stats.infected, stats.dead, economy]);

  useEffect(() => {
    if (isPlaying) {
      requestRef.current = requestAnimationFrame(loop);
    } else {
      cancelAnimationFrame(requestRef.current);
    }
    return () => cancelAnimationFrame(requestRef.current);
  }, [isPlaying, update]);

  const loop = () => {
    update();
    requestRef.current = requestAnimationFrame(loop);
  };

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const width = containerRef.current ? containerRef.current.clientWidth : 600;
    const height = 400;
    canvas.width = width;
    canvas.height = height;
    ctx.clearRect(0, 0, width, height);

    agents.forEach(agent => {
      ctx.beginPath();
      ctx.arc(agent.x, agent.y, 4, 0, 2 * Math.PI);
      if (agent.status === 'RECOVERED' && agent.immunityTimer > IMMUNITY_DURATION * 0.7) {
         ctx.fillStyle = '#6ee7b7'; 
      } else {
         ctx.fillStyle = COLORS[agent.status];
      }
      ctx.fill();
      if (agent.status === 'INFECTED') {
        ctx.beginPath();
        ctx.arc(agent.x, agent.y, INFECTION_RADIUS, 0, 2 * Math.PI);
        ctx.fillStyle = 'rgba(239, 68, 68, 0.15)'; 
        ctx.fill();
      }
    });
  }, [agents]);

  const applyPreset = (type) => {
    switch (type) {
      case 'UK_EARLY': setPolicyStringency(0); break;
      case 'CHINA_ZERO': setPolicyStringency(98); break;
      case 'EXIT_WAVE':
        setPolicyStringency(98);
        setTimeout(() => setPolicyStringency(10), 8000);
        break;
      default: break;
    }
  };

  // è©•ä¼°å ±å‘Šè¨ˆç®—
  const calculateReport = () => {
    const estimatedGDPDrop = (100 - economy).toFixed(1);
    // å‡è¨­æ¯ç´¯ç© 5000 é»ç¶“æ¿Ÿæå¤±ç©åˆ† = 100 å®¶å…¬å¸å€’é–‰
    const bankruptCompanies = Math.floor(stats.cumulativeEcoLoss / 50); 
    
    return { estimatedGDPDrop, bankruptCompanies };
  };

  const report = calculateReport();

  return (
    <div className="flex flex-col w-full max-w-4xl mx-auto p-4 space-y-6 bg-gray-50 rounded-xl shadow-lg font-sans">
      
      <div className="text-center space-y-2">
        <h1 className="text-2xl font-bold text-gray-800">COVID-19 æ¨¡æ“¬ï¼šç¶“æ¿Ÿèˆ‡ç”Ÿå‘½ä»£åƒ¹</h1>
        <p className="text-gray-600 text-sm">
          ç¶“æ¿Ÿæ¨¡å‹å·²ä¿®æ­£ï¼š<span className="font-bold text-blue-600">å¤§é‡æ­»äº¡èˆ‡ææ…Œ</span>ç¾åœ¨æœƒç›´æ¥é‡å‰µç¶“æ¿Ÿï¼Œå³ä½¿ä¸å°åŸä¹Ÿä¸€æ¨£ã€‚
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="md:col-span-2 bg-white p-2 rounded-lg shadow-inner border border-gray-200 relative h-[420px]" ref={containerRef}>
          <canvas ref={canvasRef} className="w-full h-full block rounded" />
          <div className="absolute top-2 left-2 bg-white/90 p-2 rounded text-xs space-y-1 shadow">
             <div className="flex items-center"><div className="w-3 h-3 rounded-full mr-2 bg-blue-500"></div> æ˜“æ„Ÿ</div>
             <div className="flex items-center"><div className="w-3 h-3 rounded-full mr-2 bg-red-500"></div> æ„ŸæŸ“</div>
             <div className="flex items-center"><div className="w-3 h-3 rounded-full mr-2 bg-green-500"></div> å…ç–«</div>
             <div className="flex items-center"><div className="w-3 h-3 rounded-full mr-2 bg-gray-800"></div> æ­»äº¡</div>
          </div>
          {stats.infected > HOSPITAL_CAPACITY && (
            <div className="absolute top-2 right-2 bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center animate-pulse shadow-lg">
              <ShieldAlert size={16} className="mr-1"/> é†«ç™‚å´©æ½°
            </div>
          )}
        </div>

        <div className="space-y-4 flex flex-col justify-between">
          <div className="grid grid-cols-2 gap-2">
            <div className={`p-3 rounded-lg border ${stats.infected > HOSPITAL_CAPACITY ? 'bg-red-100 border-red-500 ring-2 ring-red-300' : 'bg-red-50 border-red-100'}`}>
              <div className="text-xs text-red-500 font-bold uppercase flex items-center justify-between">
                <span><Activity size={12} className="inline mr-1"/>æ„ŸæŸ“</span>
              </div>
              <div className="text-2xl font-bold text-red-700">{stats.infected}</div>
              <div className="text-[10px] text-red-400 font-mono mt-1">
                 ä¸Šé™: {HOSPITAL_CAPACITY}
              </div>
            </div>
            <div className="bg-gray-800 p-3 rounded-lg border border-gray-700 text-white">
              <div className="text-xs text-gray-400 font-bold uppercase flex items-center">
                <Skull size={12} className="mr-1"/> æ­»äº¡
              </div>
              <div className="text-2xl font-bold text-white">{stats.dead}</div>
            </div>
            <div className="bg-green-50 p-3 rounded-lg border border-green-100">
               <div className="text-xs text-green-600 font-bold uppercase">å…ç–«</div>
               <div className="text-xl font-bold text-green-700">{stats.recovered}</div>
            </div>
            <div className={`p-3 rounded-lg border ${economy < 50 ? 'bg-orange-100 border-orange-300' : 'bg-blue-50 border-blue-100'}`}>
               <div className="text-xs text-blue-600 font-bold uppercase flex items-center">
                <TrendingUp size={12} className="mr-1"/> ç¶“æ¿ŸæŒ‡æ•¸
               </div>
               <div className={`text-xl font-bold ${economy < 50 ? 'text-orange-700' : 'text-blue-700'}`}>{Math.round(economy)}</div>
            </div>
          </div>

          <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 space-y-4">
            <div>
              <label className="text-sm font-bold text-gray-700 mb-1 block">
                æ”¿ç­–åš´æ ¼åº¦: {policyStringency}%
              </label>
              <input type="range" min="0" max="100" value={policyStringency} onChange={(e) => setPolicyStringency(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"/>
            </div>
            <div className="grid grid-cols-1 gap-2">
               <button onClick={() => applyPreset('UK_EARLY')} className="px-3 py-2 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-sm transition text-left border border-blue-200">
                 ğŸ‡¬ğŸ‡§ è‹±åœ‹å…±å­˜ (0% é™åˆ¶)
               </button>
               <button onClick={() => applyPreset('CHINA_ZERO')} className="px-3 py-2 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm transition text-left border border-red-200">
                 ğŸ‡¨ğŸ‡³ ä¸­åœ‹æ¸…é›¶ (98% é™åˆ¶)
               </button>
               <button onClick={() => applyPreset('EXIT_WAVE')} className="px-3 py-2 bg-orange-100 hover:bg-orange-200 text-orange-800 rounded text-sm transition text-left border border-orange-200 font-bold">
                 âš ï¸ æ¨¡æ“¬ 2022 è§£å°æµ·å˜¯
               </button>
            </div>
            <div className="flex gap-2 pt-2 border-t border-gray-100">
              <button onClick={() => setIsPlaying(!isPlaying)} className={`flex-1 flex items-center justify-center px-4 py-2 rounded-lg font-bold text-white transition ${isPlaying ? 'bg-amber-500 hover:bg-amber-600' : 'bg-indigo-600 hover:bg-indigo-700'}`}>
                {isPlaying ? <><Pause size={16} className="mr-2"/> æš«åœ/è©•ä¼°</> : <><Play size={16} className="mr-2"/> é–‹å§‹</>}
              </button>
              <button onClick={initializeSimulation} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg" title="é‡ç½®"><RotateCcw size={18} /></button>
            </div>
          </div>
        </div>
      </div>

      {/* ç½å¾Œè©•ä¼°å ±å‘Š (æš«åœæ™‚é¡¯ç¤º) */}
      {!isPlaying && time > 20 && (
        <div className="bg-slate-800 text-white p-6 rounded-xl shadow-2xl border border-slate-700 animate-in fade-in slide-in-from-bottom-4 duration-500">
           <h3 className="text-xl font-bold mb-4 flex items-center text-amber-400">
             <FileText className="mr-2"/> æ¨¡æ“¬çµæŸ/æš«åœï¼šç½å¾Œæç›Šè©•ä¼°æ¸…å–®
           </h3>
           <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              
              <div className="bg-slate-700 p-4 rounded-lg">
                <h4 className="text-slate-400 text-xs font-bold uppercase mb-2">ç”Ÿå‘½æå¤±</h4>
                <div className="space-y-2">
                  <div className="flex justify-between items-center">
                    <span>ç¸½æ­»äº¡äººæ•¸:</span>
                    <span className="text-2xl font-bold text-red-400">{stats.dead} äºº</span>
                  </div>
                  <div className="flex justify-between items-center text-sm">
                    <span>äººå£æ¸›å“¡æ¯”ä¾‹:</span>
                    <span>{((stats.dead / POPULATION_SIZE) * 100).toFixed(1)}%</span>
                  </div>
                  <div className="flex justify-between items-center text-sm">
                    <span>é†«ç™‚å´©æ½°æ™‚é•·:</span>
                    <span className="text-orange-400">{Math.round(stats.daysOverwhelmed / 20)} å¤©</span>
                  </div>
                </div>
              </div>

              <div className="bg-slate-700 p-4 rounded-lg border border-slate-600">
                <h4 className="text-slate-400 text-xs font-bold uppercase mb-2">ç¶“æ¿Ÿè¡æ“Š</h4>
                <div className="space-y-2">
                  <div className="flex justify-between items-center">
                    <span>ç›®å‰ GDP è¡°é€€:</span>
                    <span className="text-2xl font-bold text-blue-400">-{report.estimatedGDPDrop}%</span>
                  </div>
                  <div className="flex justify-between items-center text-sm">
                    <span className="flex items-center"><Building2 size={14} className="mr-1"/> ä¼°è¨ˆå€’é–‰ä¼æ¥­:</span>
                    <span className="text-orange-300">{report.bankruptCompanies} å®¶</span>
                  </div>
                   <div className="w-full bg-slate-900 rounded-full h-2 mt-2">
                    <div className="bg-blue-500 h-2 rounded-full" style={{ width: `${economy}%` }}></div>
                  </div>
                  <div className="text-xs text-slate-500 text-right">ç¶“æ¿Ÿæ´»åŠ›æŒ‡æ•¸</div>
                </div>
              </div>

              <div className="bg-slate-700 p-4 rounded-lg">
                <h4 className="text-slate-400 text-xs font-bold uppercase mb-2">æ¨¡å‹è©•åƒ¹</h4>
                <div className="text-sm leading-relaxed text-slate-300">
                  {stats.dead > 50 ? (
                    <span className="text-red-300">âš ï¸ **äººé“ç½é›£**ï¼šé›–ç„¶å¯èƒ½ç¶­æŒäº†éƒ¨åˆ†ç¶“æ¿Ÿæ´»å‹•ï¼Œä½†æ­»äº¡äººæ•¸éé«˜å°è‡´å‹å‹•åŠ›æ°¸ä¹…ç¼ºæï¼Œé•·æœŸç¶“æ¿Ÿæ½›åŠ›å·²å—æã€‚</span>
                  ) : economy < 40 ? (
                    <span className="text-orange-300">âš ï¸ **ç¶“æ¿Ÿè•­æ¢**ï¼šéåº¦åš´æ ¼çš„ç®¡æ§é›–ç„¶ä¿ä½äº†ç”Ÿå‘½ï¼Œä½†å°è‡´äº†å¤§é‡çš„ä¼æ¥­å€’é–‰èˆ‡å¤±æ¥­ï¼Œç¤¾æœƒå¾©ç”¦å°‡æ¥µå…¶æ¼«é•·ã€‚</span>
                  ) : (
                    <span className="text-green-300">âœ… **ç›¸å°å¹³è¡¡**ï¼šåœ¨æ§åˆ¶æ­»äº¡èˆ‡ç¶­æŒç¶“æ¿Ÿä¹‹é–“å–å¾—äº†è‰±é›£çš„å¹³è¡¡ï¼Œä½†ä»ä»˜å‡ºäº†ç›¸ç•¶ä»£åƒ¹ã€‚</span>
                  )}
                </div>
              </div>

           </div>
        </div>
      )}

      <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <h3 className="text-sm font-bold text-gray-700 mb-4 flex justify-between">
          <span>è¶¨å‹¢åœ– (ç¶“æ¿Ÿ vs ç”Ÿå‘½)</span>
        </h3>
        <div className="h-64 w-full">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={history}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
              <XAxis dataKey="time" hide />
              <YAxis yAxisId="left" domain={[0, 'auto']} label={{ value: 'äººæ•¸', angle: -90, position: 'insideLeft' }} />
              <YAxis yAxisId="right" orientation="right" domain={[0, 100]} label={{ value: 'ç¶“æ¿Ÿ', angle: 90, position: 'insideRight' }} />
              <Tooltip labelFormatter={() => ''} />
              <ReferenceLine y={HOSPITAL_CAPACITY} yAxisId="left" stroke="red" strokeDasharray="3 3" strokeWidth={2} label="é†«ç™‚å´©æ½°" />
              <Line yAxisId="left" type="monotone" dataKey="infected" stroke="#ef4444" strokeWidth={2} dot={false} name="æ„ŸæŸ“" animationDuration={500} />
              <Line yAxisId="left" type="monotone" dataKey="dead" stroke="#1f2937" strokeWidth={3} dot={false} name="æ­»äº¡" animationDuration={500} />
              <Line yAxisId="right" type="monotone" dataKey="economy" stroke="#3b82f6" strokeWidth={2} dot={false} name="ç¶“æ¿Ÿ" animationDuration={500} />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>

    </div>
  );
};

export default App;